<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Fshow/Votação</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="icon" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png" type="image/png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="icon" type="image/png" sizes="192x192" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">

  <link rel="apple-touch-icon" sizes="57x57" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">

  <link rel="icon" type="image/png" sizes="192x192" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="icon" type="image/png" sizes="512x512" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">

  <meta name="theme-color" content="#8A2BE2">
  <meta name="msapplication-TileColor" content="#FF8C00">
  <meta name="msapplication-TileImage" content="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">

  <link rel="icon" type="image/png" sizes="192x192" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="icon" type="image/png" sizes="512x512" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <link rel="mask-icon" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png" color="#ff8c00">
  <link rel="manifest" href="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <meta name="msapplication-TileColor" content="#ff8c00">
  <meta name="msapplication-TileImage" content="https://i.ibb.co/0Vv5RSLg/Logo-Fshow2.png">
  <meta name="theme-color" content="#8a2be2">

  <style>
    /* ===== VARIÁVEIS GLOBAIS ===== */
    :root {
      --bg: #121212;
      --card-bg: #2b2b2b;
      --accent: #00b7b0;
      --text: #fff;
      --muted: #bdbdbd;
      --border-radius: 8px;
      --transition: all 0.3s ease;
      --shadow-md: 0 4px 14px rgba(0, 0, 0, 0.4);
      --panel-border: rgba(255, 255, 255, 0.06);
    }

    /* ===== BASE ===== */
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Inter", Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 10% 20%, rgba(0, 183, 176, 0.32), transparent 55%),
        radial-gradient(circle at 85% 75%, rgba(0, 110, 255, 0.28), transparent 60%),
        radial-gradient(circle at 50% -20%, rgba(200, 0, 255, 0.25), transparent 70%),
        linear-gradient(145deg, #0a0b0d, #101218 45%, #060708);
      background-attachment: fixed;
      background-size: cover;
      min-height: 100vh;
    }

    .container {
      max-width: 400px;
      margin: 0 auto;
      padding: 20px 15px;
      animation: slideUp 0.6s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 { font-size: 20px; font-weight: 700; margin-bottom: 10px; text-align: left; }
    h2 { font-size: 14px; color: var(--muted); margin-bottom: 20px; font-weight: 400; }

    /* ===== OPÇÕES ===== */
    .options { display: flex; flex-direction: column; gap: 12px; }

    .option {
      display: flex;
      background: var(--card-bg);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--border-radius);
      overflow: hidden;
      cursor: pointer;
      transition: var(--transition);
    }

    .option:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
      border-color: var(--accent);
    }

    .option img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .option-content {
      display: flex;
      align-items: center;
      padding: 0 15px;
      width: 100%;
      font-size: 18px;
      font-weight: 500;
    }

    .option-content input[type="radio"] {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid var(--muted);
      border-radius: 50%;
      margin-right: 10px;
      cursor: pointer;
      position: relative;
    }

    .option-content input[type="radio"]:checked { border-color: var(--accent); }
    .option-content input[type="radio"]:checked::before {
      content: "";
      position: absolute;
      inset: 3px;
      border-radius: 50%;
      background: var(--accent);
    }

    /* ===== HCAPTCHA & BUTTON ===== */
    .captcha-container {
      margin: 20px 0;
      display: flex;
      justify-content: center;
    }

    button#botaoVotar {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      background: #444;
      color: var(--muted);
      transition: var(--transition);
    }

    button#botaoVotar.active {
      background: var(--accent);
      color: #fff;
    }

    button#botaoVotar:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .notice { font-size: 12px; color: var(--muted); text-align: center; margin-top: 15px; }

    /* ===== TELA DE SUCESSO ===== */
    #confirmTela {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      min-height: 80vh;
      text-align: center;
    }

    .confirm-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
    }

    .confirm-card img {
      width: 100%;
      height: 250px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    #nomeConfirm { font-size: 24px; font-weight: 700; margin: 10px 0; }
    .success-msg { color: #00ff99; font-weight: 600; margin: 15px 0; }

    .voltar {
      background: var(--accent);
      color: #fff;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
    }

    /* ===== TELA DE ERRO ===== */
    #errorTela {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      min-height: 80vh;
      text-align: center;
    }

    .error-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
    }

    .error-msg { color: #ff6b6b; font-weight: 600; margin: 15px 0; font-size: 18px; }
    .error-detail { color: var(--muted); font-size: 14px; margin: 10px 0; }

    /* DESKTOP */
    @media (min-width: 1024px) {
      .container { max-width: 900px; }
      .options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      .option { flex-direction: column; }
      .option img { width: 100%; height: 200px; }
      .option-content { padding: 15px; background: #1f1f1f; }
    }
  </style>

  <!-- SDKs -->
  <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <div id="votoTela" class="container">
    <h1>Quem você quer que FIQUE na F10? <br> Apenas um voto por pessoa. </h1>
    <div class="options">
      
    <label class="option">
    <img src="https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Caio.jpg?raw=true" alt="Opção 2">
    <div class="option-content">
      <input type="radio" name="vote" value="Caio"> Caio
    </div>
    </label>
  
  <label class="option">
      <img src="https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Fernanda.jpg?raw=true" alt="Opção 1">
    <div class="option-content">
      <input type="radio" name="vote" value="Fernanda"> Fernanda
    </div>
  </label>
  
    <label class="option">
    <img src="https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Paiva.jpg?raw=true" alt="Opção 3">
    <div class="option-content">
      <input type="radio" name="vote" value="Paiva"> Paiva
    </div>
  </label>
  
    </div>
    <div class="captcha-container">
      <div class="h-captcha" data-sitekey="6dfe175a-b5e8-4474-ac38-a84436a8004c" data-callback="onCaptchaSuccess" data-theme="dark"></div>
    </div>

    <button id="botaoVotar" disabled>Votar</button>
    <div class="notice">A votação segue aberta até às 19:00</div>
  </div>

  <div id="confirmTela">
    <div class="confirm-card">
      <img id="fotoConfirm" src="" alt="Voto"/>
      <p id="nomeConfirm"></p>
      <div class="success-msg">✔ Voto computado com sucesso!</div>
      <button class="voltar" href="votefshow.html">Voto da Torcida</button>
    </div>
  </div>

  <div id="errorTela">
    <div class="error-card">
      <div class="error-msg">⚠ Já votou!</div>
      <div class="error-detail" id="errorMessage"></div>
      <button class="voltar" onclick="location.reload()" style="margin-top: 20px;">TENTAR NOVAMENTE</button>
    </div>
  </div>

  <script>
    /* ======================================================
       CONFIGURAÇÃO CENTRAL
    ====================================================== */
    const ROUND_ID = "rodada_03"; 

    const SUPABASE_URL = "https://beuqcarjvvjjmwoedvsc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJldXFjYXJqdnZqam13b2VkdnNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MzUxODQsImV4cCI6MjA4NDQxMTE4NH0.RxFRnk7zqPCJcIcF99BdPYLPRFtMR99diu4lU9pENJ4";
    const TABLE_NAME = "roça3f10";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const aberturaBR = new Date("2026-01-18T19:00:00");
    const encerramentoBR = new Date("2026-01-22T19:00:00");

  // =================== HORA DO SERVIDOR (Via API Pública) ===================
  async function getServerTime() {
    try {
      const res = await fetch("https://worldtimeapi.org/api/timezone/America/Sao_Paulo");
      const data = await res.json();
      return new Date(data.datetime);
    } catch (e) {
      console.error("Erro ao verificar horário:", e);
      return new Date(); 
    }
  }

  function toSaoPauloDate(date) {
    const spString = date.toLocaleString("en-US", { timeZone: "America/Sao_Paulo" });
    return new Date(spString);
  }

  function redirect(url) {
  if (DEBUG) {
    console.warn("REDIRECT BLOQUEADO →", url);
    return;
  }
  window.location.href = url;
}

  // =================== VERIFICAÇÃO DE HORÁRIO ===================
  async function verificarHorarios() {
    const agoraServer = await getServerTime();
    const agoraBR = toSaoPauloDate(agoraServer);

    if (agoraBR < aberturaBR) {
      window.location.replace("aguarde.html");
      return;
    }

    if (agoraBR > encerramentoBR) {
      window.location.replace("fechada.html");
      return;
    }

    console.log("VOTAÇÃO ABERTA");
  }

  verificarHorarios();
    /* ======================================================
       ESTADO E ELEMENTOS
    ====================================================== */
    const botaoVotar = document.getElementById("botaoVotar");
    const votoTela = document.getElementById("votoTela");
    const confirmTela = document.getElementById("confirmTela");
    const errorTela = document.getElementById("errorTela");
    const nomeConfirm = document.getElementById("nomeConfirm");
    const fotoConfirm = document.getElementById("fotoConfirm");
    const errorMessage = document.getElementById("errorMessage");
    
    let captchaToken = null;
    let userIP = null;

    const fotos = {
      "Caio": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Caio.jpg?raw=true",
      "Cícero": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Cícero.jpg?raw=true",
      "Duck": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Duck.jpg?raw=true",
      "Ella": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Ella.jpg?raw=true",
      "Eueu": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Eueu.jpg?raw=true",
      "Fernanda": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Fernanda.jpg?raw=true",
      "João": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/João.jpg?raw=true",
      "Kelvin": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Kelvin.jpg?raw=true",
      "Koyuh": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Koyuh.jpg?raw=true",
      "Luca": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Luca.jpg?raw=true",
      "Lucas": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Lucas.jpg?raw=true",
      "Luddy": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Luddy.jpg?raw=true",
      "Ludmila": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Ludmila.jpg?raw=true",
      "Mari": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Mari.jpg?raw=true",
      "Mariana": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Mariana.jpg?raw=true",
      "Mikael": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Mikael.jpg?raw=true",
      "Mira": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Mira.jpg?raw=true",
      "Nick": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Nick.jpg?raw=true",
      "Paiva": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Paiva.jpg?raw=true",
      "Renata": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Renata.jpg?raw=true",
      "Rose": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Rose.jpg?raw=true",
      "Vitor": "https://github.com/VulgoFshow/New-Fshow/blob/main/fotos/Vitor.jpg?raw=true"
    };

    /* ======================================================
       FUNÇÕES
    ====================================================== */
    
    /**
     * Obtém o IP do usuário
     */
    async function getIP() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        console.log("IP obtido:", data.ip);
        return data.ip;
      } catch (e) { 
        console.error("Erro ao obter IP:", e);
        return null; 
      }
    }

    /**
     * Callback do hCaptcha - chamado quando o captcha é completado
     */
    window.onCaptchaSuccess = function(token) {
      console.log("hCaptcha completado com sucesso");
      captchaToken = token;
      checkReady();
    };

    /**
     * Verifica se pode habilitar o botão de votação
     */
    function checkReady() {
      const selecionado = document.querySelector('input[name="vote"]:checked');
      if (selecionado && captchaToken) {
        botaoVotar.disabled = false;
        botaoVotar.classList.add("active");
        console.log("Botão habilitado - Opção selecionada:", selecionado.value);
      } else {
        botaoVotar.disabled = true;
        botaoVotar.classList.remove("active");
      }
    }

    document.querySelectorAll('input[name="vote"]').forEach(radio => {
      radio.addEventListener('change', checkReady);
    });

    function showError(mensagem) {
      votoTela.style.display = "none";
      confirmTela.style.display = "none";
      errorTela.style.display = "flex";
      errorMessage.textContent = mensagem;
      console.error("Erro exibido:", mensagem);
    }


    async function submitVote() {
      const selecionado = document.querySelector('input[name="vote"]:checked');
      
      // Validações iniciais
      if (!selecionado) {
        alert("Por favor, selecione uma opção!");
        return;
      }

      if (!captchaToken) {
        alert("Por favor, complete o captcha!");
        return;
      }

      // Desabilita o botão durante o processamento
      botaoVotar.disabled = true;
      botaoVotar.innerText = "Processando...";

      try {
        // 1. Obter IP do usuário
        console.log("Iniciando processo de votação...");
        userIP = await getIP();

        if (!userIP) {
          throw new Error("Não foi possível obter seu IP. Verifique sua conexão.");
        }

        // 2. Verificar se já votou nesta rodada (LocalStorage)
        const votoAnterior = localStorage.getItem("voted_fshow_round");
        if (votoAnterior === ROUND_ID) {
          console.log("Já votou");
          showError("É permitido apenas um voto por pessoa.");
          return;
        }

        // 3. Enviar voto para Supabase
        console.log("Enviando voto para Supabase...");
        const { data, error } = await supabaseClient
          .from(TABLE_NAME)
          .insert([{ 
            participante: selecionado.value, 
            ip: userIP,
            round_id: ROUND_ID,
            hcaptcha_token: captchaToken
          }])
          .select();

        // 4. Tratamento de erros do Supabase
        if (error) {
          console.error("Erro do Supabase:", error);
          
          // Verifica se é erro de constraint (voto duplicado)
          if (error.code === '23505' || error.message.includes('duplicate')) {
            console.log("Voto duplicado detectado");
            localStorage.setItem("voted_fshow_round", ROUND_ID);
            showError("Este IP já registrou um voto nesta rodada!");
            return;
          }

          // Outros erros
          throw new Error(error.message || "Erro desconhecido ao enviar voto");
        }

        // 5. Verificar se a inserção foi bem-sucedida
        if (!data || data.length === 0) {
          throw new Error("Voto não foi registrado no banco de dados");
        }

        console.log("Voto registrado com sucesso:", data);

        // 6. Marcar como votado no localStorage
        localStorage.setItem("voted_fshow_round", ROUND_ID);

        // 7. Exibir tela de sucesso
        votoTela.style.display = "none";
        errorTela.style.display = "none";
        confirmTela.style.display = "flex";
        nomeConfirm.textContent = selecionado.value;
        fotoConfirm.src = fotos[selecionado.value] || "";

        console.log("Voto computado com sucesso!");

      } catch (e) {
        console.error("Erro durante votação:", e);
        showError(e.message || "Erro ao votar. Tente novamente.");
        botaoVotar.disabled = false;
        botaoVotar.innerText = "Votar";
      }
    }

    /**
     * Evento de clique do botão de votação
     */
    botaoVotar.onclick = submitVote;

    /**
     * Verificação inicial ao carregar a página
     */
    (async function init() {
      console.log("Página carregada");
      
      // Se já votou nesta rodada, você pode adicionar lógica aqui
      const votoAnterior = localStorage.getItem("voted_fshow_round");
      if (votoAnterior === ROUND_ID) {
        console.log("Usuário já votou nesta rodada");
        // Opcional: Mostrar mensagem ou bloquear interface
      }
    })();
  </script>
</body>
</html>

